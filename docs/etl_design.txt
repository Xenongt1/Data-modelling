ETL Architecture: Production SQL Implementation
-------------------------------------------------

Implementation Strategy:
- **Approach**: ELT (Extract, Load, Transform) using Native SQL.
- **Goal**: High-performance "Set-Based" operations instead of row-by-row processing.
- **Execution**: Managed by `sql/production_etl.sql`.

Dimension Load Logic:
1. dim_date:
   - **Method**: Stored Procedure `GenerateDimDate(start_date, end_date)`.
   - **Logic**: Iterates from start to end date, calculating quarters/months, and bulk inserts.

2. dim_patient:
   - **Method**: `INSERT INTO ... SELECT`.
   - **Logic**: Directly transforms `dob` to `current_age` using `TIMESTAMPDIFF`.

3. dim_provider:
   - **Method**: Denormalized Join.
   - **Logic**: Joins `providers` + `specialties` + `departments` to flatten hierarchy into a single dimension.

Fact Table Load Logic (fact_encounters):
1. **Billing Aggregation (Crucial Step)**:
   - Pre-aggregates `billing` table by `encounter_id` using `SUM()` to handle multiple bills per encounter.
   - **New**: Extracts `claim_date` (via MAX) to link revenue to the payment timeline.
   - Ensures one row per encounter in the Fact table.

2. **Metrics Calculation**:
   - `length_of_stay`: Calculated as `ROUND(TIMESTAMPDIFF(SECOND, encounter_date, discharge_date) / 86400.0)`. stored as `INT`.
   - `total_claim_amount`: Mapped from pre-aggregated sum.
   - `total_allowed_amount`: Mapped from pre-aggregated sum WHERE `claim_status = 'Paid'`.
   - `encounter_date`, `discharge_date`, `claim_date`: Denormalized directly onto Fact table (Smart Keys).
   - `diagnosis_count`: Calculated via Correlated Subquery on `encounter_diagnoses`.
   - `procedure_count`: Calculated via Correlated Subquery on `encounter_procedures`.

3. **Surrogate Key Lookup**:
   - Joins Fact source directly to Dimensions (`dim_patient`, etc.) to resolve Keys during the INSERT.

Bridge Table Load Logic:
1. bridge_encounter_diagnoses:
   - Joins `encounter_diagnoses` -> `fact_encounters` -> `dim_diagnosis`.
   - resolves `encounter_key` and `diagnosis_key` in a single pass.

2. bridge_encounter_procedures:
   - Similar logic for procedures, resolving `procedure_key` and `procedure_date_key`.

Refresh Strategy:
- **Current**: TRUNCATE + RELOAD (Full Refresh).
- **Production**: Would use `WHERE encounter_date > :last_load_date`.
